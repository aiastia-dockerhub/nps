FROM golang:1.21-alpine as builder

# 设置Go代理和禁用校验
ENV GOPROXY=https://goproxy.cn,direct
ENV GOSUMDB=off
ENV CGO_ENABLED=0

WORKDIR /go/src/ehang.io/nps
COPY . .

# 下载依赖并验证
RUN go mod download
RUN go mod verify

# 构建二进制文件
RUN go build -ldflags="-w -s -extldflags -static" ./cmd/npc/npc.go

# 使用alpine作为基础镜像（包含CA证书）
FROM alpine:latest

# 安装CA证书
RUN apk --no-cache add ca-certificates

WORKDIR /app
COPY --from=builder /go/src/ehang.io/nps/npc .

VOLUME /conf
ENTRYPOINT ["./npc"]
